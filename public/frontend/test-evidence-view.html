<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence View Test - VIOVERSE</title>
    <style>
        body { margin: 0; font-family: system-ui; background: #1a1a1a; color: white; }
        .header { padding: 20px; background: #2a2a2a; border-bottom: 1px solid #444; }
        .container { padding: 20px; }
        .status { padding: 10px; background: #333; border-radius: 4px; margin: 10px 0; }
        .success { background: #2d5016; }
        .error { background: #5a1e1e; }
        .info { background: #1e3a5a; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: #2a2a2a; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .card:hover { border-color: #666; }
        .category { display: inline-block; padding: 4px 8px; background: #444; border-radius: 4px; font-size: 12px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .search-box { width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 4px; color: white; }
        .results { margin-top: 20px; }
        .result-item { background: #2a2a2a; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 3px solid #4CAF50; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Evidence View Test - A+ Compliant System</h1>
        <p>Testing data-driven evidence management with vector search</p>
    </div>

    <div class="container">
        <div id="status" class="status">Loading evidence system...</div>

        <div style="margin: 20px 0;">
            <button onclick="loadEvidence()">Load Evidence Manifest</button>
            <button onclick="initVectorSystem()">Initialize Vectors</button>
            <button onclick="showCategories()">Show Categories</button>
            <button onclick="showStatistics()">Show Statistics</button>
            <button onclick="openEvidenceView()">Open Full Evidence View</button>
        </div>

        <div style="margin: 20px 0;">
            <h3>Vector Search Test</h3>
            <input type="text" class="search-box" id="searchQuery" placeholder="Try: credit denial, smoking gun, ally financial...">
            <button onclick="performSearch()">Search Evidence</button>
            <div id="searchResults" class="results"></div>
        </div>

        <h3>Evidence Documents</h3>
        <div id="documentGrid" class="grid"></div>

        <h3>Category Breakdown</h3>
        <div id="categories"></div>
    </div>

    <!-- Load Vector System -->
    <script src="js/evidence-vector-system.js"></script>

    <script>
        let manifest = null;
        let vectorSystem = null;

        // Load evidence manifest
        async function loadEvidence() {
            try {
                const response = await fetch('../data/config/evidence-manifest-complete.json');
                manifest = await response.json();

                updateStatus(`✅ Loaded ${manifest.meta.totalDocuments} evidence documents`, 'success');

                // Display first 20 documents
                displayDocuments(manifest.documents.slice(0, 20));

                return manifest;
            } catch (error) {
                updateStatus(`❌ Error loading manifest: ${error.message}`, 'error');
            }
        }

        // Initialize vector system
        async function initVectorSystem() {
            if (!manifest) {
                await loadEvidence();
            }

            vectorSystem = new EvidenceVectorSystem();
            await vectorSystem.initialize(manifest.documents);

            const stats = vectorSystem.getStatistics();
            updateStatus(`✅ Vector system initialized: ${stats.totalDocuments} documents, ${stats.vocabularySize} terms`, 'success');
        }

        // Perform vector search
        async function performSearch() {
            if (!vectorSystem) {
                await initVectorSystem();
            }

            const query = document.getElementById('searchQuery').value;
            if (!query) return;

            const results = vectorSystem.search(query, 10);

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<h4>Search Results for "${query}":</h4>`;

            results.forEach(result => {
                const doc = result.document;
                resultsDiv.innerHTML += `
                    <div class="result-item">
                        <strong>${doc.title}</strong><br>
                        <small>
                            Score: ${result.score.toFixed(3)} |
                            ${doc.creditor} |
                            ${doc.date} |
                            <span class="category">${doc.category}</span>
                        </small>
                    </div>
                `;
            });
        }

        // Display documents in grid
        function displayDocuments(documents) {
            const grid = document.getElementById('documentGrid');
            grid.innerHTML = '';

            documents.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'card';

                const categoryColor = manifest.meta.categories[doc.category]?.color || '#666';

                card.innerHTML = `
                    <h4 style="margin: 0 0 10px 0;">${doc.title.substring(0, 50)}${doc.title.length > 50 ? '...' : ''}</h4>
                    <p style="margin: 5px 0;">
                        <small>
                            <strong>Date:</strong> ${doc.date}<br>
                            <strong>Creditor:</strong> ${doc.creditor}<br>
                            <strong>Type:</strong> ${doc.documentType}<br>
                            <strong>Pages:</strong> ${doc.pageCount}<br>
                            <strong>Impact:</strong> ${doc.impactScore}/10<br>
                            <span class="category" style="background: ${categoryColor};">${doc.category}</span>
                        </small>
                    </p>
                `;

                grid.appendChild(card);
            });
        }

        // Show categories
        function showCategories() {
            if (!manifest) return;

            const categoriesDiv = document.getElementById('categories');
            categoriesDiv.innerHTML = '';

            Object.entries(manifest.meta.categories).forEach(([key, cat]) => {
                const count = manifest.meta.statistics.byCategory[key] || 0;
                categoriesDiv.innerHTML += `
                    <div style="display: inline-block; margin: 5px; padding: 10px; background: #2a2a2a; border-radius: 4px;">
                        <span style="font-size: 24px;">${cat.icon}</span>
                        <strong>${cat.label}</strong>: ${count} documents
                    </div>
                `;
            });
        }

        // Show statistics
        function showStatistics() {
            if (!manifest) return;

            const stats = manifest.meta.statistics;
            let html = '<h3>Evidence Statistics</h3><div class="status info">';

            html += '<strong>By Temporal Period:</strong><br>';
            Object.entries(stats.byTemporal).forEach(([period, count]) => {
                html += `${period}: ${count}<br>`;
            });

            html += '<br><strong>By Category:</strong><br>';
            Object.entries(stats.byCategory).forEach(([cat, count]) => {
                html += `${cat}: ${count}<br>`;
            });

            html += '<br><strong>Impact Analysis:</strong><br>';
            html += `Smoking Guns: ${stats.byImpactLevel.smokingGuns}<br>`;
            html += `High Impact: ${stats.byImpactLevel.highImpact}<br>`;
            html += `Total Documents: ${stats.byImpactLevel.total}<br>`;

            html += '</div>';

            updateStatus(html, 'info');
        }

        // Open full evidence view
        function openEvidenceView() {
            window.open('evidence-view.html', '_blank');
        }

        // Update status display
        function updateStatus(message, type = '') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = `status ${type}`;
        }

        // Auto-load on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadEvidence();
            await initVectorSystem();
            showCategories();
        });

        // Handle Enter key in search box
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchQuery').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });
    </script>
</body>
</html>