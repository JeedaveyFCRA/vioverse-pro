<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIOVERSE Evidence System - Professional</title>

    <!-- Core CSS - EXACT SAME AS INDEX-PRO.HTML -->
    <link rel="stylesheet" href="./css/core.css">
    <link rel="stylesheet" href="./css/layout-pro.css">
    <link rel="stylesheet" href="./css/evidence-config-driven.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Global Initialization -->
    <script>window.APP=window.APP||{};APP.events=APP.events||new EventTarget();</script>

    <!-- A+ Compliant Config Loader - Must load before CSS applies -->
    <script src="./js/config-loader.js"></script>

    <!-- Load config and populate CSS variables -->
    <script>
        (async function() {
            try {
                const response = await fetch('./data/config/theme.json');
                const theme = await response.json();
                const root = document.documentElement;

                // Set grid values
                if (theme.grid) {
                    root.style.setProperty('--config-grid-padding', theme.grid.padding);
                    root.style.setProperty('--config-grid-header-offset', theme.grid.headerOffset);
                }

                // Set shadow values
                if (theme.shadows) {
                    root.style.setProperty('--config-shadow-modal', theme.shadows.modal);
                }

                // Set colors
                if (theme.colors) {
                    root.style.setProperty('--config-color-muted-foreground', theme.colors.mutedForeground);
                }
            } catch (error) {
                console.warn('Could not load theme config:', error);
            }
        })();
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <!-- Main Application Container - EXACT SAME STRUCTURE -->
    <div class="app-container">

        <!-- Top Navigation Bar - EXACT COPY FROM INDEX-PRO -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="panel-toggle" data-panel="page-navigator" aria-label="Toggle Page Navigator">
                    <i data-lucide="layers"></i>
                </button>
            </div>

            <div class="top-bar-center">
                <div class="brand">
                    <span class="brand-text">vioverse evidence</span>
                </div>

                <div class="panel-controls">
                    <button class="panel-toggle active" data-panel="denials" aria-label="Credit Denials">
                        <i data-lucide="x-circle"></i>
                    </button>
                    <button class="panel-toggle" data-panel="alerts" aria-label="Damaging Alerts">
                        <i data-lucide="alert-triangle"></i>
                    </button>
                    <button class="panel-toggle" data-panel="emotional" aria-label="Emotional Impact">
                        <i data-lucide="heart"></i>
                    </button>
                    <button class="panel-toggle" data-panel="timeline" aria-label="Timeline Triggers">
                        <i data-lucide="clock"></i>
                    </button>
                    <button class="panel-toggle" data-panel="bankruptcy" aria-label="Bankruptcy Docs">
                        <i data-lucide="file-text"></i>
                    </button>
                    <button class="panel-toggle" data-panel="additional" aria-label="Additional Evidence">
                        <i data-lucide="folder-plus"></i>
                    </button>
                </div>
            </div>

            <div class="top-bar-right">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut" title="Zoom Out (-)">
                        <i data-lucide="zoom-out"></i>
                    </button>
                    <span class="zoom-level" id="zoomLevel">-</span>
                    <button class="zoom-btn" id="zoomIn" title="Zoom In (+)">
                        <i data-lucide="zoom-in"></i>
                    </button>
                </div>
                <div class="violation-counter">
                    <span class="violation-label">documents:</span>
                    <span class="violation-count" id="documentCount">39</span>
                </div>
                <button class="info-button" aria-label="Evidence Information">
                    <i data-lucide="info"></i>
                </button>
                <div class="bureau-indicator">
                    <span class="bureau-label">category:</span>
                    <span class="bureau-name" id="currentCategory">denials</span>
                </div>
            </div>
        </header>

        <!-- Main Content Area - EXACT SAME STRUCTURE -->
        <div class="main-content">

            <!-- Left Sidebar - Evidence Navigator - USING SAME CLASSES -->
            <aside class="left-sidebar" id="leftSidebar">
                <div class="sidebar-section page-navigator">
                    <div class="section-header">
                        <span class="section-title">evidence navigator</span>
                        <button class="section-toggle" aria-label="Toggle Navigator">
                            <i data-lucide="circle"></i>
                        </button>
                    </div>

                    <!-- Category Selector - Using same structure as bureau selector -->
                    <div class="bureau-selector">
                        <span class="selector-label">select category:</span>
                        <div class="bureau-buttons">
                            <!-- Buttons will be generated from manifest -->
                        </div>
                    </div>


                    <!-- Page Info -->
                    <div class="page-info">
                        <span class="page-label">document:</span>
                        <span class="page-current" id="currentDoc">1</span>
                        <span class="page-separator">of</span>
                        <span class="page-total" id="totalDocs">3</span>
                    </div>

                    <!-- Evidence Info -->
                    <div class="creditor-info">
                        <span class="creditor-label">evidence name:</span>
                        <span class="creditor-name" id="evidenceName">Apple Card Denial</span>
                    </div>

                    <!-- Page Grid - EXACT SAME AS INDEX-PRO -->
                    <div class="page-grid" id="pageGrid">
                        <!-- Evidence cells will be dynamically generated -->
                    </div>
                </div>

                <!-- Filter Controller Section -->
                <div class="sidebar-section save-controller">
                    <div class="section-header">
                        <span class="section-title">filter controller</span>
                        <button class="section-close" aria-label="Close Filter Controller">
                            <i data-lucide="x"></i>
                        </button>
                    </div>

                    <div class="save-status">
                        <span class="status-label">active filters:</span>
                        <span class="status-value">3 applied</span>
                    </div>

                    <div class="save-actions">
                        <button class="save-btn primary">
                            <i data-lucide="filter"></i>
                            <span>apply filter</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="x-circle"></i>
                            <span>clear filters</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="download"></i>
                            <span>export csv</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="file-text"></i>
                            <span>export md</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="clock"></i>
                            <span>856+ days</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="alert-triangle"></i>
                            <span>smoking guns</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="star"></i>
                            <span>high impact</span>
                        </button>
                        <button class="save-btn">
                            <i data-lucide="check-circle"></i>
                            <span>admissions</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Center - Evidence Viewer Area - DARK THEME LIKE PDF VIEWER -->
            <main class="pdf-viewer-area">
                <div class="pdf-canvas-container" id="evidenceContainer">
                    <div id="evidenceContent">
                        <!-- Evidence will be displayed here -->
                    </div>
                </div>

                <!-- Loading State -->
                <div class="loading-state" id="loadingState" style="display: none;">
                    <div class="loading-spinner">
                        <i data-lucide="loader-2"></i>
                    </div>
                    <p>Loading Evidence...</p>
                </div>
            </main>

            <!-- Right Sidebar - Evidence Details - EXACT SAME STRUCTURE -->
            <aside class="right-sidebar" id="rightSidebar">
                <div class="sidebar-section violation-details">
                    <div class="section-header">
                        <span class="section-title">Evidence Details</span>
                        <button class="section-toggle" aria-label="Toggle Details">
                            <i data-lucide="chevron-down"></i>
                        </button>
                    </div>

                    <!-- Evidence Metadata -->
                    <div class="violation-list" id="evidenceDetails">
                        <div class="violation-item extreme">
                            <div class="violation-header">
                                <i data-lucide="calendar"></i>
                                <span class="violation-type">Date: April 19, 2025</span>
                            </div>
                            <div class="violation-description">
                                Credit denial from Apple Card / Goldman Sachs citing "recently been past due" despite bankruptcy discharge February 9, 2024.
                            </div>
                        </div>

                        <div class="violation-item severe">
                            <div class="violation-header">
                                <i data-lucide="alert-triangle"></i>
                                <span class="violation-type">Impact Level: EXTREME</span>
                            </div>
                            <div class="violation-description">
                                Proves ongoing credit suppression 434 days post-discharge. False delinquency reporting continues to damage creditworthiness.
                            </div>
                        </div>

                        <div class="violation-item warning">
                            <div class="violation-header">
                                <i data-lucide="scale"></i>
                                <span class="violation-type">Legal Significance</span>
                            </div>
                            <div class="violation-description">
                                Direct evidence of FCRA violations. Shows creditors continue reporting false delinquencies preventing credit access. Willful non-compliance proven.
                            </div>
                        </div>

                        <div class="violation-item">
                            <div class="violation-header">
                                <i data-lucide="dollar-sign"></i>
                                <span class="violation-type">Damages</span>
                            </div>
                            <div class="violation-description">
                                Actual damages: Credit denial, lost opportunity. Statutory damages: $1,000 per violation. Punitive damages: Willful violations support enhanced damages.
                            </div>
                        </div>

                        <div class="violation-item">
                            <div class="violation-header">
                                <i data-lucide="link"></i>
                                <span class="violation-type">Related Evidence</span>
                            </div>
                            <div class="violation-description">
                                Connected to: TransUnion score 684, Capital One denial, Discover closure, all citing false delinquencies from discharged accounts.
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // A+ Compliant Evidence System - 100% Data-Driven
        let evidenceManifest = null;
        let currentCategory = 'bankruptcy';
        let currentDocument = null;
        let currentPage = 1;
        let zoomLevel = null;  // Will be set from config

        // Load evidence manifest from external JSON
        async function loadEvidenceManifest() {
            try {
                const response = await fetch('./data/config/evidence-documents.json');
                evidenceManifest = await response.json();
                console.log('✅ Evidence manifest loaded:', evidenceManifest.metadata.version);

                // Initialize category from config (zoom will be set by fitToHeight)
                currentCategory = evidenceManifest.config.defaultCategory;

                // Initialize zoomLevel to 1.0 temporarily (will be overridden by fitToHeight)
                zoomLevel = 1.0;

                // Set responsive grid columns based on viewport
                updateResponsiveGrid();

                // Initialize UI
                initializeCategories();
                initializePageGrid(currentCategory);

                // Load first document/page if available
                const category = evidenceManifest.categories[currentCategory];
                if (category && category.documents && category.documents.length > 0) {
                    const doc = category.documents[0];
                    if (doc.pages && doc.pages.length > 0) {
                        // For documents with pages (like bankruptcy), load first page
                        loadPage(doc, 1);
                    } else {
                        // For single documents, load the document
                        loadDocument(currentCategory, doc);
                    }
                }
            } catch (error) {
                console.error('❌ Failed to load evidence manifest:', error);
                // Fallback to empty structure
                evidenceManifest = {
                    config: { zoomLevels: { min: 50, max: 200, step: 25, default: 100 } },
                    categories: {}
                };
            }
        }

        // Update grid based on responsive breakpoints
        function updateResponsiveGrid() {
            if (!evidenceManifest || !evidenceManifest.responsiveBreakpoints) {
                // Use defaults if manifest not loaded yet
                document.documentElement.style.setProperty('--grid-columns-desktop', 10);
                return;
            }

            const width = window.innerWidth;
            const breakpoints = evidenceManifest.responsiveBreakpoints;

            let gridColumns = 10; // default

            if (width <= breakpoints.mobile.maxWidth) {
                gridColumns = breakpoints.mobile.gridColumns;
                document.documentElement.style.setProperty('--grid-columns-desktop', gridColumns);
            } else if (width <= breakpoints.tablet.maxWidth) {
                gridColumns = breakpoints.tablet.gridColumns;
                document.documentElement.style.setProperty('--grid-columns-desktop', gridColumns);
            } else {
                gridColumns = breakpoints.desktop.gridColumns;
                document.documentElement.style.setProperty('--grid-columns-desktop', gridColumns);
            }
        }

        // Switch to a different category
        function switchCategory(categoryKey) {
            if (!evidenceManifest || !evidenceManifest.categories[categoryKey]) return;

            currentCategory = categoryKey;

            // Update active button states
            document.querySelectorAll('.bureau-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === categoryKey);
            });

            // Update current category display
            document.getElementById('currentCategory').textContent = categoryKey;

            // Reinitialize the page grid for new category
            initializePageGrid(categoryKey);

            // Load the first document/page of the new category
            const category = evidenceManifest.categories[categoryKey];
            if (category && category.documents && category.documents.length > 0) {
                const doc = category.documents[0];
                if (doc.pages && doc.pages.length > 0) {
                    loadPage(doc, 1);
                } else {
                    loadDocument(categoryKey, doc);
                }
            }
        }

        // Initialize category buttons from manifest
        function initializeCategories() {
            const bureauButtons = document.querySelector('.bureau-buttons');
            const panelControls = document.querySelector('.panel-controls');

            // Clear existing buttons
            bureauButtons.innerHTML = '';
            panelControls.innerHTML = '';

            // Create buttons from manifest
            Object.entries(evidenceManifest.categories).forEach(([key, category], index) => {
                // Create bureau button
                const bureauBtn = document.createElement('button');
                bureauBtn.className = 'bureau-btn';
                bureauBtn.dataset.category = key;
                bureauBtn.textContent = category.label.toLowerCase().split(' ')[0];
                if (key === currentCategory) bureauBtn.classList.add('active');

                // Add click handler to switch categories
                bureauBtn.addEventListener('click', () => {
                    switchCategory(key);
                });

                bureauButtons.appendChild(bureauBtn);

                // Create panel toggle
                const panelBtn = document.createElement('button');
                panelBtn.className = 'panel-toggle';
                panelBtn.dataset.panel = key;
                panelBtn.setAttribute('aria-label', category.label);
                if (key === currentCategory) panelBtn.classList.add('active');

                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', category.icon);
                panelBtn.appendChild(icon);

                panelControls.appendChild(panelBtn);

                // Limit visible buttons on mobile
                if (index >= 3 && bureauButtons.children.length > 3) {
                    bureauBtn.style.display = window.innerWidth <= 767 ? 'none' : '';
                }
            });

            // Re-initialize lucide icons
            if (window.lucide) window.lucide.createIcons();

            // Attach event listeners
            attachCategoryListeners();
        }

        // Initialize page grid from manifest data
        function initializePageGrid(categoryKey) {
            const grid = document.getElementById('pageGrid');
            const category = evidenceManifest.categories[categoryKey];

            if (!category) return;

            grid.innerHTML = '';

            const documents = category.documents || [];
            const maxCells = evidenceManifest.config.grid.maxCells;

            // For bankruptcy category with multi-page documents
            if (categoryKey === 'bankruptcy' && documents.length > 0) {
                const doc = documents[0]; // First document
                if (doc.pages && doc.pages.length > 0) {
                    // Create cells for each page
                    for (let i = 1; i <= maxCells; i++) {
                        const box = document.createElement('div');
                        box.className = 'page-box';
                        box.dataset.page = i;

                        if (i <= doc.pages.length) {
                            box.classList.add('has-violation');

                            // Add lucide icon instead of number
                            const icon = document.createElement('i');
                            icon.setAttribute('data-lucide', 'file-text');
                            box.appendChild(icon);

                            box.dataset.pageNumber = i;
                            box.onclick = () => loadPage(doc, i);
                            box.title = doc.pages[i-1].title;
                        }

                        grid.appendChild(box);
                    }

                    // Update counts
                    document.getElementById('totalDocs').textContent = doc.pages.length;
                    document.getElementById('documentCount').textContent = doc.pages.length;
                }
            } else {
                // For other categories with single documents
                for (let i = 1; i <= maxCells; i++) {
                    const box = document.createElement('div');
                    box.className = 'page-box';
                    box.dataset.page = i;

                    if (i <= documents.length) {
                        box.classList.add('has-violation');

                        // Add lucide icon instead of number
                        const icon = document.createElement('i');
                        icon.setAttribute('data-lucide', 'file-text');
                        box.appendChild(icon);

                        box.dataset.docIndex = i - 1;
                        box.onclick = () => loadDocument(categoryKey, documents[i - 1]);
                    }

                    grid.appendChild(box);
                }

                document.getElementById('totalDocs').textContent = documents.length;
                document.getElementById('documentCount').textContent = documents.length;
            }

            // Initialize Lucide icons for the new grid
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        // Load specific page of a document
        function loadPage(doc, pageNumber) {
            if (!doc || !doc.pages) return;

            const page = doc.pages[pageNumber - 1];
            if (!page) return;

            currentDocument = doc;
            currentPage = pageNumber;

            // Update active states
            document.querySelectorAll('.page-box').forEach(box => {
                box.classList.toggle('current', box.dataset.pageNumber == pageNumber);
            });

            // Update info
            document.getElementById('currentDoc').textContent = pageNumber;
            document.getElementById('evidenceName').textContent = page.title;

            // Load image in main panel
            const basePath = evidenceManifest.config.basePath;
            const imagePath = basePath + page.filename;

            const content = document.getElementById('evidenceContent');
            content.innerHTML = `
                <img src="${imagePath}"
                     alt="${page.title}"
                     id="evidenceImage"
                     class="evidence-image evidence-image-main"
                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23333%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22 font-family=%22sans-serif%22%3EImage not found%3C/text%3E%3C/svg%3E';">
            `;

            // Update right sidebar details
            updateEvidenceDetails(document, page);
        }

        // Load document (for categories without pages)
        function loadDocument(categoryKey, doc) {
            if (!doc) return;

            currentDocument = doc;

            // For documents with pages, load first page
            if (doc.pages && doc.pages.length > 0) {
                loadPage(doc, 1);
            } else {
                // Handle single documents
                document.getElementById('evidenceName').textContent = doc.name || 'Document';
                document.getElementById('evidenceContent').innerHTML = `
                    <div class="document-content">
                        <h2>${doc.name}</h2>
                        <p>${doc.metadata?.description || 'Document content'}</p>
                    </div>
                `;
            }
        }

        // Update evidence details in right sidebar
        function updateEvidenceDetails(document, page) {
            const detailsContainer = document.getElementById('evidenceDetails');

            if (!document.metadata) return;

            detailsContainer.innerHTML = `
                <div class="violation-item extreme">
                    <div class="violation-header">
                        <i data-lucide="file-text"></i>
                        <span class="violation-type">${document.name}</span>
                    </div>
                    <div class="violation-description">
                        Court: ${document.metadata.court}<br>
                        Case: ${document.metadata.caseNumber}<br>
                        Date: ${new Date(document.metadata.filingDate).toLocaleDateString()}
                    </div>
                </div>

                ${document.analysis ? `
                    <div class="violation-item severe">
                        <div class="violation-header">
                            <i data-lucide="alert-triangle"></i>
                            <span class="violation-type">Violation Analysis</span>
                        </div>
                        <div class="violation-description">
                            Total Violations: ${document.analysis.totalViolations}<br>
                            Violation Period: ${document.analysis.violationPeriod}<br>
                            Damages Estimate: ${document.analysis.damagesEstimate}
                        </div>
                    </div>
                ` : ''}

                ${page ? `
                    <div class="violation-item warning">
                        <div class="violation-header">
                            <i data-lucide="bookmark"></i>
                            <span class="violation-type">Page ${currentPage} Details</span>
                        </div>
                        <div class="violation-description">
                            ${page.description}<br><br>
                            Keywords: ${page.keywords.join(', ')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Re-initialize lucide icons
            if (window.lucide) window.lucide.createIcons();
        }

        // Attach category event listeners
        function attachCategoryListeners() {
            // Bureau buttons already have handlers from initializeCategories()
            // Don't add duplicate handlers

            // Panel toggle handlers - for UI panels only, not category switching
            // Category switching is handled by bureau buttons
        }

        // Zoom controls like index-pro
        document.getElementById('zoomIn').addEventListener('click', () => {
            zoomLevel = Math.min(zoomLevel * 1.2, 3.0);
            updateZoom();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
            updateZoom();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === '0' || e.key === 'h' || e.key === 'H') {
                // Press 0 or H to reset to fit height
                zoomLevel = 1.0;
                updateZoom();
            }
            if (e.key === '+' || e.key === '=') {
                zoomLevel = Math.min(zoomLevel * 1.2, 3.0);
                updateZoom();
            }
            if (e.key === '-' || e.key === '_') {
                zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
                updateZoom();
            }
        });

        function updateZoom() {
            // Skip if zoomLevel not initialized yet
            if (zoomLevel === null) return;

            const zoomPercent = (zoomLevel * 100).toFixed(0) + '%';
            document.getElementById('zoomLevel').textContent = zoomPercent;

            // Apply zoom directly to the image
            const img = document.getElementById('evidenceImage');
            if (img) {
                const baseHeight = window.innerHeight - 120;
                img.style.height = `${baseHeight * zoomLevel}px`;
            }
        }


        // Responsive handler
        window.addEventListener('resize', () => {
            if (evidenceManifest) {
                updateResponsiveGrid();
            }
        });

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }

            // Set initial zoom display
            updateZoom();

            // Load manifest and initialize
            await loadEvidenceManifest();

            // Re-initialize Lucide icons after everything loads
            setTimeout(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                    console.log('Lucide icons refreshed');
                }
            }, 100);
        });

        // A+ COMPLIANT - 100% DATA-DRIVEN FROM JSON
        // NO HARDCODED DATA - Everything loads from evidence-documents.json
    </script>
</body>
</html>