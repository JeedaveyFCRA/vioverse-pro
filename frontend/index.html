<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viobox Viewer - Multi-Bureau System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        /* Main PDF Viewer - Center Stage */
        .pdf-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #2d2d2d;
            position: relative;
        }
        
        /* Top Control Bar */
        .top-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
            flex-wrap: wrap;
        }
        
        .title {
            font-size: 18px;
            font-weight: 600;
            margin-right: auto;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .file-label:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Bureau Filters */
        .bureau-filters {
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.2);
            padding: 8px 15px;
            border-radius: 5px;
        }
        
        .bureau-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        
        .bureau-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .bureau-checkbox.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .bureau-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .badge-tu {
            background: #4CAF50;
        }
        
        .badge-ex {
            background: #2196F3;
        }
        
        .badge-eq {
            background: #FF9800;
        }
        
        .control-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .control-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.2);
            padding: 3px;
            border-radius: 5px;
        }
        
        .zoom-btn {
            padding: 5px 10px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* PDF Navigation */
        .pdf-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .pdf-nav button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .pdf-nav button:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }
        
        .pdf-nav button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .pdf-info {
            color: white;
            font-size: 12px;
            padding: 0 10px;
        }
        
        /* Status Bar */
        .status-bar {
            background: #252525;
            padding: 8px 15px;
            font-size: 12px;
            color: #aaa;
            border-top: 1px solid #333;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-label {
            color: #777;
        }
        
        .status-value {
            color: #fff;
            font-weight: 600;
        }
        
        /* Canvas Container - Full Height */
        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            background: #1a1a1a;
            position: relative;
        }
        
        #pdfCanvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #888;
        }
        
        .loading-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Right Sidebar - Compact */
        .sidebar {
            width: 350px;
            background: #1f1f1f;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 15px;
            background: #2a2a2a;
            border-bottom: 1px solid #333;
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #fff;
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #aaa;
        }
        
        .legend-box {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            border: 1px solid;
        }
        
        /* Current PDF Info */
        .current-pdf-info {
            padding: 10px 15px;
            background: #252525;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        
        .pdf-name {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .violation-count {
            color: #888;
            font-size: 11px;
        }
        
        /* Violations List */
        .violations-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .violation-item {
            background: #2a2a2a;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid;
            font-size: 12px;
            transition: transform 0.2s, background 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .violation-item:hover {
            transform: translateX(3px);
            background: #333;
        }
        
        .violation-item.extreme {
            border-color: #dc3545;
        }
        
        .violation-item.severe {
            border-color: #fd7e14;
        }
        
        .violation-item.serious {
            border-color: #facc15;
        }
        
        .violation-item.minor {
            border-color: #0dcaf0;
        }
        
        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .violation-rule {
            font-weight: 600;
            color: #fff;
        }
        
        .violation-severity {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        
        .severity-extreme {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
        }
        
        .severity-severe {
            background: rgba(253, 126, 20, 0.2);
            color: #ffa94d;
        }
        
        .severity-serious {
            background: rgba(250, 204, 21, 0.2);
            color: #facc15;
        }
        
        .severity-minor {
            background: rgba(13, 202, 240, 0.2);
            color: #4fc3f7;
        }
        
        .violation-text {
            color: #888;
            font-size: 11px;
            margin-bottom: 3px;
        }
        
        .violation-coords {
            color: #666;
            font-size: 10px;
            font-family: monospace;
        }
        
        .violation-bureau {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }
        
        /* Stats Summary */
        .stats-summary {
            padding: 15px;
            background: #2a2a2a;
            border-top: 1px solid #333;
        }
        
        .overall-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            margin-top: 2px;
        }
        
        .bureau-stats {
            font-size: 11px;
            color: #888;
        }
        
        .bureau-stat-item {
            padding: 2px 0;
            display: flex;
            justify-content: space-between;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        .notification.error {
            background: #f44336;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Main PDF Viewer Area -->
        <div class="pdf-viewer">
            <!-- Top Control Bar -->
            <div class="top-controls">
                <div class="title">🎯 VIOBOX VIEWER - Multi-Bureau</div>
                
                <input type="file" id="csvFiles" class="file-input" accept=".csv" multiple>
                <label for="csvFiles" class="file-label">📊 Load CSV(s)</label>
                
                <input type="file" id="pdfFiles" class="file-input" accept=".pdf" multiple>
                <label for="pdfFiles" class="file-label">📄 Load PDFs</label>
                
                <div class="bureau-filters">
                    <label class="bureau-checkbox">
                        <input type="checkbox" id="filterTU" checked>
                        <span>TransUnion</span>
                        <span class="bureau-badge badge-tu" id="badgeTU">0</span>
                    </label>
                    <label class="bureau-checkbox">
                        <input type="checkbox" id="filterEX" checked>
                        <span>Experian</span>
                        <span class="bureau-badge badge-ex" id="badgeEX">0</span>
                    </label>
                    <label class="bureau-checkbox">
                        <input type="checkbox" id="filterEQ" checked>
                        <span>Equifax</span>
                        <span class="bureau-badge badge-eq" id="badgeEQ">0</span>
                    </label>
                </div>
                
                <button class="control-btn" onclick="toggleVioboxes()" id="toggleBtn" disabled>
                    👁️ Toggle Boxes
                </button>
                
                <div class="pdf-nav">
                    <button onclick="previousPDF()" id="prevBtn" disabled>◀</button>
                    <span class="pdf-info" id="pdfInfo">No PDFs loaded</span>
                    <button onclick="nextPDF()" id="nextBtn" disabled>▶</button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="changeScale(0.75)">75%</button>
                    <button class="zoom-btn" onclick="changeScale(1.0)">100%</button>
                    <button class="zoom-btn" onclick="changeScale(1.5)">150%</button>
                </div>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-label">CSVs Loaded:</span>
                    <span class="status-value" id="csvCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">PDFs Loaded:</span>
                    <span class="status-value" id="pdfCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current Bureau:</span>
                    <span class="status-value" id="currentBureau">-</span>
                </div>
                <div class="status-item" id="mismatchWarning" style="display: none; color: #ff9800;">
                    ⚠️ <span id="mismatchText"></span>
                </div>
            </div>
            
            <!-- Canvas Container -->
            <div class="canvas-container">
                <canvas id="pdfCanvas" style="display: none;"></canvas>
                <div class="loading" id="loading">
                    <div class="loading-icon">📂</div>
                    <div>1. Load CSV files (TU, EX, and/or EQ)</div>
                    <div>2. Load PDF files from selected bureaus</div>
                    <div>3. Use checkboxes to filter by bureau</div>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Sidebar Header with Legend -->
            <div class="sidebar-header">
                <div class="sidebar-title">Violations by Bureau</div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(220, 53, 69, 0.3); border-color: #dc3545;"></div>
                        <span>Extreme</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(253, 126, 20, 0.3); border-color: #fd7e14;"></div>
                        <span>Severe</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(250, 204, 21, 0.3); border-color: #facc15;"></div>
                        <span>Serious</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(13, 202, 240, 0.3); border-color: #0dcaf0;"></div>
                        <span>Minor</span>
                    </div>
                </div>
            </div>
            
            <!-- Current PDF Info -->
            <div class="current-pdf-info">
                <div class="pdf-name" id="currentPdfName">No PDF loaded</div>
                <div class="violation-count" id="currentViolationCount">0 violations on this page</div>
            </div>
            
            <!-- Violations List -->
            <div class="violations-container" id="violationList">
                <!-- Violations will be added here -->
            </div>
            
            <!-- Stats Summary -->
            <div class="stats-summary">
                <div class="overall-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalCount">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="extremeCount" style="color: #ff6b6b;">0</div>
                        <div class="stat-label">Extreme</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="severeCount" style="color: #ffa94d;">0</div>
                        <div class="stat-label">Severe</div>
                    </div>
                </div>
                <div class="bureau-stats" id="bureauStats">
                    <!-- Bureau breakdown will go here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Global variables
        let allCsvData = [];  // All violations from all CSVs
        let filteredCsvData = [];  // Filtered by bureau checkboxes
        let allViolations = {};  // Grouped by PDF filename
        let pdfFiles = {};  // Store uploaded PDFs
        let currentPdfIndex = 0;
        let pdfFileNames = [];
        let filteredPdfNames = [];  // PDFs after bureau filtering
        let scale = 1.0;
        let showVioboxes = true;
        let currentPdfDoc = null;
        let loadedCsvCount = 0;
        let bureauCounts = { TU: 0, EX: 0, EQ: 0 };
        
        // Detect bureau from filename
        function detectBureau(filename) {
            if (filename.includes('-TU-') || filename.includes('_TU_')) return 'TU';
            if (filename.includes('-EX-') || filename.includes('_EX_')) return 'EX';
            if (filename.includes('-EQ-') || filename.includes('_EQ_')) return 'EQ';
            return 'UNKNOWN';
        }
        
        // Handle CSV upload (multiple files)
        document.getElementById('csvFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            loadedCsvCount = 0;
            allCsvData = [];  // Reset
            
            files.forEach(file => {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        const validData = results.data.filter(row => 
                            row.violation_type && 
                            row.violation_type !== 'No Violations Found' &&
                            !row.violation_type.startsWith('COMBO_')
                        );
                        
                        // Add bureau info to each row based on filename
                        validData.forEach(row => {
                            if (row.pdf_filename) {
                                row.bureau = detectBureau(row.pdf_filename);
                            }
                        });
                        
                        allCsvData = allCsvData.concat(validData);
                        loadedCsvCount++;
                        
                        if (loadedCsvCount === files.length) {
                            processCombinedCsvData();
                            document.getElementById('csvCount').textContent = loadedCsvCount;
                            showNotification(`Loaded ${loadedCsvCount} CSV file(s) with ${allCsvData.length} violations`, 'success');
                        }
                    },
                    error: function(error) {
                        showNotification('Error parsing CSV: ' + error, 'error');
                    }
                });
            });
        });
        
        // Handle PDF uploads (multiple)
        document.getElementById('pdfFiles').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            let loadedCount = 0;
            pdfFiles = {};  // Reset
            
            for (const file of files) {
                if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const typedArray = new Uint8Array(arrayBuffer);
                    
                    try {
                        const pdfDoc = await pdfjsLib.getDocument(typedArray).promise;
                        pdfFiles[file.name] = pdfDoc;
                        loadedCount++;
                        console.log('Loaded PDF:', file.name, 'Bureau:', detectBureau(file.name));
                    } catch (error) {
                        console.error('Error loading PDF:', file.name, error);
                    }
                }
            }
            
            if (loadedCount > 0) {
                pdfFileNames = Object.keys(pdfFiles);
                document.getElementById('pdfCount').textContent = loadedCount;
                updateBureauCounts();
                showNotification(`Loaded ${loadedCount} PDF files!`, 'success');
                enableControls();
                applyBureauFilters();  // Apply filters and check for mismatches
                
                if (filteredPdfNames.length > 0) {
                    displayFirstPdf();
                }
            }
        });
        
        function updateBureauCounts() {
            bureauCounts = { TU: 0, EX: 0, EQ: 0 };
            pdfFileNames.forEach(name => {
                const bureau = detectBureau(name);
                if (bureau in bureauCounts) {
                    bureauCounts[bureau]++;
                }
            });
            
            document.getElementById('badgeTU').textContent = bureauCounts.TU;
            document.getElementById('badgeEX').textContent = bureauCounts.EX;
            document.getElementById('badgeEQ').textContent = bureauCounts.EQ;
        }
        
        function processCombinedCsvData() {
            // Group violations by PDF filename
            allViolations = {};
            allCsvData.forEach(row => {
                if (row.pdf_filename) {
                    if (!allViolations[row.pdf_filename]) {
                        allViolations[row.pdf_filename] = [];
                    }
                    allViolations[row.pdf_filename].push(row);
                }
            });
            
            console.log('Processed violations for PDFs:', Object.keys(allViolations).length);
            updateOverallStats();
            checkForMismatches();
        }
        
        function checkForMismatches() {
            // Check if PDFs loaded match CSVs loaded
            const csvPdfNames = new Set(Object.keys(allViolations));
            const loadedPdfNames = new Set(pdfFileNames);
            
            const missingCsvForPdfs = pdfFileNames.filter(name => !csvPdfNames.has(name));
            const missingPdfForCsvs = Array.from(csvPdfNames).filter(name => !loadedPdfNames.has(name));
            
            if (missingCsvForPdfs.length > 0) {
                const bureaus = [...new Set(missingCsvForPdfs.map(detectBureau))];
                const warning = `${missingCsvForPdfs.length} PDF(s) loaded without CSV data (${bureaus.join(', ')})`;
                document.getElementById('mismatchText').textContent = warning;
                document.getElementById('mismatchWarning').style.display = 'block';
                showNotification(warning + '. Consider loading the corresponding CSV files.', 'warning');
            } else {
                document.getElementById('mismatchWarning').style.display = 'none';
            }
        }
        
        function applyBureauFilters() {
            const showTU = document.getElementById('filterTU').checked;
            const showEX = document.getElementById('filterEX').checked;
            const showEQ = document.getElementById('filterEQ').checked;
            
            filteredPdfNames = pdfFileNames.filter(name => {
                const bureau = detectBureau(name);
                return (bureau === 'TU' && showTU) ||
                       (bureau === 'EX' && showEX) ||
                       (bureau === 'EQ' && showEQ);
            });
            
            // Update filtered CSV data
            filteredCsvData = allCsvData.filter(row => {
                const bureau = row.bureau || detectBureau(row.pdf_filename || '');
                return (bureau === 'TU' && showTU) ||
                       (bureau === 'EX' && showEX) ||
                       (bureau === 'EQ' && showEQ);
            });
            
            updateOverallStats();
        }
        
        // Bureau filter change handlers
        document.getElementById('filterTU').addEventListener('change', () => {
            applyBureauFilters();
            if (currentPdfDoc) displayCurrentPdf();
        });
        
        document.getElementById('filterEX').addEventListener('change', () => {
            applyBureauFilters();
            if (currentPdfDoc) displayCurrentPdf();
        });
        
        function enableControls() {
            document.getElementById('toggleBtn').disabled = false;
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
        }
        
        async function displayFirstPdf() {
            currentPdfIndex = 0;
            await displayCurrentPdf();
        }
        
        async function displayCurrentPdf() {
            if (filteredPdfNames.length === 0) {
                document.getElementById('loading').innerHTML = 
                    '<div class="loading-icon">⚠️</div><div>No PDFs match the selected bureau filters</div>';
                return;
            }
            
            const pdfName = filteredPdfNames[currentPdfIndex];
            if (!pdfName || !pdfFiles[pdfName]) {
                console.error('PDF not found:', pdfName);
                return;
            }
            
            currentPdfDoc = pdfFiles[pdfName];
            const bureau = detectBureau(pdfName);
            
            // Update UI
            document.getElementById('loading').style.display = 'none';
            document.getElementById('pdfCanvas').style.display = 'block';
            document.getElementById('currentPdfName').textContent = pdfName;
            document.getElementById('currentBureau').textContent = bureau;
            document.getElementById('pdfInfo').textContent = `${currentPdfIndex + 1} / ${filteredPdfNames.length}`;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentPdfIndex === 0;
            document.getElementById('nextBtn').disabled = currentPdfIndex === filteredPdfNames.length - 1;
            
            // Get violations for this PDF (filtered by bureau)
            const currentViolations = (allViolations[pdfName] || []).filter(v => {
                const vBureau = v.bureau || detectBureau(v.pdf_filename || '');
                const showTU = document.getElementById('filterTU').checked;
                const showEX = document.getElementById('filterEX').checked;
                const showEQ = document.getElementById('filterEQ').checked;
                
                return (vBureau === 'TU' && showTU) ||
                       (vBureau === 'EX' && showEX) ||
                       (vBureau === 'EQ' && showEQ);
            });
            
            document.getElementById('currentViolationCount').textContent = 
                `${currentViolations.length} violations on this page`;
            
            // Display violations in sidebar
            displayViolationsList(currentViolations);
            
            // Render PDF
            await renderPage(1);  // Always render first page for now
        }
        
        async function renderPage(pageNum) {
            if (!currentPdfDoc) return;
            
            const page = await currentPdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.getElementById('pdfCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Render PDF
            await page.render(renderContext).promise;
            
            // Draw vioboxes if enabled
            if (showVioboxes) {
                const pdfName = filteredPdfNames[currentPdfIndex];
                const violations = (allViolations[pdfName] || []).filter(v => {
                    const vBureau = v.bureau || detectBureau(v.pdf_filename || '');
                    const showTU = document.getElementById('filterTU').checked;
                    const showEX = document.getElementById('filterEX').checked;
                    const showEQ = document.getElementById('filterEQ').checked;
                    
                    return (vBureau === 'TU' && showTU) ||
                           (vBureau === 'EX' && showEX) ||
                           (vBureau === 'EQ' && showEQ);
                });
                drawVioboxes(ctx, violations, viewport);
            }
        }
        
        function drawVioboxes(ctx, violations, viewport) {
            violations.forEach(violation => {
                // Skip violations without coordinates
                if (!violation.x || !violation.y || !violation.width || !violation.height) {
                    return;
                }
                
                // Parse coordinates
                const x = parseFloat(violation.x) * scale;
                const width = parseFloat(violation.width) * scale;
                const height = parseFloat(violation.height) * scale;
                const y = parseFloat(violation.y) * scale;
                
                // Choose color based on severity
                let strokeColor, fillColor;
                switch((violation.severity || '').toLowerCase()) {
                    case 'extreme':
                        strokeColor = '#dc3545';
                        fillColor = 'rgba(220, 53, 69, 0.15)';
                        break;
                    case 'severe':
                        strokeColor = '#fd7e14';
                        fillColor = 'rgba(253, 126, 20, 0.15)';
                        break;
                    case 'serious':
                        strokeColor = '#facc15';
                        fillColor = 'rgba(250, 204, 21, 0.15)';
                        break;
                    case 'minor':
                        strokeColor = '#0dcaf0';
                        fillColor = 'rgba(13, 202, 240, 0.15)';
                        break;
                    default:
                        strokeColor = '#6c757d';
                        fillColor = 'rgba(108, 117, 125, 0.15)';
                }
                
                // Draw filled rectangle
                ctx.fillStyle = fillColor;
                ctx.fillRect(x, y - height, width, height);
                
                // Draw border
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y - height, width, height);
                
                // Add label if rule_id exists
                if (violation.rule_id) {
                    ctx.fillStyle = strokeColor;
                    ctx.font = `bold ${11 * scale}px Arial`;
                    ctx.fillText(violation.rule_id, x + 4, y - height - 4);
                }
            });
        }
        
        function displayViolationsList(violations) {
            const listDiv = document.getElementById('violationList');
            listDiv.innerHTML = '';
            
            violations.forEach((violation, index) => {
                const div = document.createElement('div');
                const severity = (violation.severity || 'minor').toLowerCase();
                const bureau = violation.bureau || detectBureau(violation.pdf_filename || '');
                div.className = `violation-item ${severity}`;
                
                let coordsText = '';
                if (violation.x && violation.y) {
                    coordsText = `<div class="violation-coords">x:${violation.x} y:${violation.y}</div>`;
                }
                
                // Bureau badge color
                let bureauClass = 'badge-tu';
                if (bureau === 'EX') bureauClass = 'badge-ex';
                if (bureau === 'EQ') bureauClass = 'badge-eq';
                
                div.innerHTML = `
                    <div class="violation-bureau bureau-badge ${bureauClass}">${bureau}</div>
                    <div class="violation-header">
                        <span class="violation-rule">${violation.rule_id || 'N/A'}</span>
                        <span class="violation-severity severity-${severity}">${violation.severity || 'Minor'}</span>
                    </div>
                    <div class="violation-text">${violation.full_text || violation.violation_type}</div>
                    ${coordsText}
                `;
                listDiv.appendChild(div);
            });
        }
        
        function updateOverallStats() {
            const dataToUse = filteredCsvData.length > 0 ? filteredCsvData : allCsvData;
            const total = dataToUse.length;
            const extreme = dataToUse.filter(v => (v.severity || '').toLowerCase() === 'extreme').length;
            const severe = dataToUse.filter(v => (v.severity || '').toLowerCase() === 'severe').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('extremeCount').textContent = extreme;
            document.getElementById('severeCount').textContent = severe;
            
            // Update bureau breakdown
            const bureauBreakdown = { TU: 0, EX: 0, EQ: 0 };
            dataToUse.forEach(v => {
                const bureau = v.bureau || detectBureau(v.pdf_filename || '');
                if (bureau in bureauBreakdown) {
                    bureauBreakdown[bureau]++;
                }
            });
            
            const statsDiv = document.getElementById('bureauStats');
            statsDiv.innerHTML = '<div style="margin-bottom: 5px; font-weight: 600;">Violations by Bureau:</div>';
            
            Object.entries(bureauBreakdown).forEach(([bureau, count]) => {
                if (count > 0) {
                    const div = document.createElement('div');
                    div.className = 'bureau-stat-item';
                    div.innerHTML = `
                        <span>${bureau === 'TU' ? 'TransUnion' : bureau === 'EX' ? 'Experian' : 'Equifax'}:</span>
                        <span>${count}</span>
                    `;
                    statsDiv.appendChild(div);
                }
            });
        }
        
        function toggleVioboxes() {
            showVioboxes = !showVioboxes;
            document.getElementById('toggleBtn').textContent = showVioboxes ? '👁️ Hide Boxes' : '👁️ Show Boxes';
            renderPage(1);
        }
        
        function changeScale(newScale) {
            scale = newScale;
            renderPage(1);
        }
        
        async function previousPDF() {
            if (currentPdfIndex > 0) {
                currentPdfIndex--;
                await displayCurrentPdf();
            }
        }
        
        async function nextPDF() {
            if (currentPdfIndex < filteredPdfNames.length - 1) {
                currentPdfIndex++;
                await displayCurrentPdf();
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
    </script>
</body>
</html>